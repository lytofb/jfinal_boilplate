<#include "/emp2/common/_layout.html"/>
<@css>
    <!--icheck-->
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/minimal.css" rel="stylesheet">
    <!--tags input-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.css" />
    <!--pickers css-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datepicker/css/datepicker-custom.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-timepicker/css/timepicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />

    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_page.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_table.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/data-tables/DT_bootstrap.css" rel="stylesheet"> 
  
</@css>
<@layout>
    <style type="text/css">
    .checkbox label, .radio label {
        padding-left: 0px;
        margin-bottom: 0;
    }
    .groupOptions{
        display: none;
    }    
    /**
    **/
    .modal-body{
        padding: 10px 15px 0px 15px;
    }

    .modal-header{
        padding:8px;
    }

    .modal-title{
        font-size:14px;
    }
    .modal-footer{
        padding: 5px;
        margin-top:initial;
    }
    </style>
        <#include "/emp2/common/dataListGroupFilterComp.html"/>
        <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="groupFilterModal">
        </div>
       
        <!--body wrapper start-->
        <div class="wrapper">
            <div class="row">
            <div class="col-sm-12">
            <section class="panel">
                <header class="panel-heading" style="position: relative">
                    列表
                <div style="position:absolute;top: 8px;right: 10px">

                <span class="pull-right">
                     <button class="btn btn-default groupFilterButton">
                        <i class="fa fa-cogs"></i>
                    </button>                            
                </span>
                <span class="pull-right" style="margin: 0px 5px 0px 5px;">
                     <button class="btn btn-default filterButton">
                        <i class="fa fa-filter"></i>
                    </button>                            
                </span>
                </div>
                </header>
                <div class="panel-body">
                    <div class="adv-table">
                        <table class="display table table-bordered" id="hidden-table-info">
                        <thead>
                        <tr id="tableTheadTemplateTarget">
                        </tr>
                        </thead>
                        <tbody id="tableTdTemplateTarget">
                        </tbody>
                        </table>
                    </div>
                </div>
            </section>
            </div>
            </div>
            <#include "/emp2/common/filterComp.html"/>
            <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="filterModal">
            </div>
        </div>
        <!--body wrapper end-->

<!--         footer section start
        <footer>
            2014 &copy; AdminEx by ThemeBucket
        </footer>
        footer section end -->

</section>
</@layout> 
<@script>
    <#include "/emp2/common/tableComp.html"/>
        <!--
    <script type="text/javascript"
        src="${base_path}/emp2/js/advanced-datatable/js/jquery.dataTables.js"></script>
    -->
    <!--icheck -->
    <script src="${base_path}/emp2/js/iCheck/jquery.icheck.js"></script>
    <script type="text/javascript"
        src="${base_path}/emp2/js/jquery.dataTables110.js"></script>
    <script type="text/javascript"
        src="${base_path}/emp2/js/data-tables/DT_bootstrap.js"></script>
    <!--tags input-->
    <script src="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.js"></script>
    <!--pickers plugins-->
    <script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
    <script src="${base_path}/emp2/js/jsrender.js" type="text/javascript"></script>
    <script src="${base_path}/emp2/js/nnitScript.js" type="text/javascript"></script>
    <script type="text/javascript">
        //dataTable filterinput style
        $.fn.dataTableExt.oStdClasses["sFilterInput"] = "form-control";

        var schema_current_data = {};
        var schema_map = {};
        var form_data = [];
        var meta_data = [];
        var displayNameMap = {};
        var _global_filter_temp={};
        var dataSource = [];
        var controller_data = {};

        var initControllerData = function(){
            //根据schema以及cwtp初始化controller
            controller_data = $.extend(true,{},schema_current_data.data);
            controller_data.filter = _global_filter_temp;
            controller_data.filterColumn = [];
            controller_data.groupDataDetail=[];
        }

        var initDisplayNameMap = function () {
            var groupData = controller_data.groupdata;
            var numberData = controller_data.numberdata;
            $.each(groupData, function(index, val) {
                 /* iterate through array or object */
                 displayNameMap[val.columname] = val.displayname;
            });
            $.each(numberData, function(index, val) {
                 /* iterate through array or object */
                 displayNameMap[val.columname] = val.displayname;
            });
        }

        var initSchema = function () {
            var url = '${base_path}/eco/getSchema';
            var fun = function (data) {
                meta_data = [];
                schema_current_data =data.schema_list[0];
                $.each(schema_current_data.data.groupdata, function(index, val) {
                     meta_data.push(val.displayname);
                     schema_map[val.displayname] = val.columname;
                });
                // queryForForm(schema_current_data);
            };
            var errfun = function () {};
            var datatype = 'json';
            var data = {'userId':${userid},'token':1};
            var deferedObject = commonPost(url,fun,errfun,datatype,data);

            deferedObject.then(function(){
                initControllerData();
                initDisplayNameMap();
                initGroupMember();
                drawTable();
            }, function(){
                console.log("fail")
            }).then(function(){console.log("thenthen")}, function(){console.log("thenthen")})
        }

        var initGroupMember = function(){
            var url = '${base_path}/eco/getGroupDataDetail';
            var fun = function(data){
                controller_data.groupDataDetail = data;
            }
            var errfun = function(){}
            var datatype = 'json';
            var data = {'userId':${userid},'token':1,'schemaid':schema_current_data.schemaid};
            var deferedObject = commonPost(url,fun,errfun,datatype,data);
            deferedObject.then(function(){
                $(document).on('click', '.groupFilterButton', function(event) {
                    event.preventDefault();
                    /* Act on the event */
                    showGroupFilterModal();
                });
            }, function(){
                console.log("fail")
            })
        }

        var initGroupFilterModal = function (data) {
            $( "#groupFilterModal" ).html(
                $( "#groupFilterTemplate" ).render(data)
            );
            initIcheck();
        }

        var initIcheck = function(){
            $('.minimal input').iCheck({
                checkboxClass: 'icheckbox_minimal',
                radioClass: 'iradio_minimal',
                increaseArea: '20%' // optional
            });
        }

        var initifClickBind = function () {
            $(document).on('ifChecked', '.groupFilter input', function(event) {
            // $(".groupFilter input").on('ifChecked', function(event) {
                event.preventDefault();
                /* Act on the event */
                var col = $(this).attr("data-value");
                $(this).parents(".icheck").find(".groupFilter").hide();
                $(this).parents(".groupFilter").show();
                $("."+col).show();
                // $(".groupOptions").find("."+col).show();
            });

            $(document).on('ifUnchecked', '.groupFilter input', function(event) {
            // $(".groupFilter input").on('ifUnchecked', function(event) {
                event.preventDefault();
                /* Act on the event */
                var col = $(this).attr("data-value");
                $(this).parents(".icheck").find(".groupFilter").show();
                $("."+col).hide();
                // $(".groupOptions").find("."+col).hide();
            });    
        }

        var showGroupFilterModal = function(){
            $("#groupFilterModal").one('show.bs.modal', function (e) {
                initGroupFilterModal(controller_data)
                initifClickBind();
            })
            $('#groupFilterModal').modal('show')

        }

        var queryForForm = function (schema_data) {
            var url = '${base_path}/eco/getFormData';
            var fun = function (data) {
                renderTable(table_meta,data);
            }
            var errfun = function (data) {

            }
            var datatype = 'json';
            var data = {'userId':${userid},'token':1};
            var extcolumn = undefined;

            $.each(controller_data.groupDataDetail, function(index, val) {
                if (val.msourceElement.checked) {
                    if (!extcolumn) {
                        extcolumn={'numberColumn':'money'};
                    };
                    extcolumn.columnname = val.msourceElement.field
                    $.each(val.mmemberList, function(index, val) {
                        if (val.checked) {
                            if(extcolumn.columoptions){
                                extcolumn.columoptions.push(val.mName)
                            } else {
                                extcolumn.columoptions = [val.mName]
                            }
                        };
                    });
                };
                 /* iterate through array or object */
            });
            // var extcolumn = {'columnname':'sub_category','columoptions':['银行存款','固定资产'],'numberColumn':'money'};
            var meta_convert = [];
            $.each(meta_data, function(index, val) {
                meta_convert.push(schema_map[val])
            });
            var table_meta = $.extend(true,[], meta_data);
            if (extcolumn) {
                var meta_index = meta_convert.indexOf(extcolumn.columnname);
                meta_convert.splice(meta_index,1);
                table_meta.splice(meta_index,1);
                table_meta = table_meta.concat(extcolumn.columoptions)
                table_meta.push(extcolumn.numberColumn)
            } else {
                meta_convert.push(schema_current_data.data.numberdata[0].columname)
                table_meta.push(schema_current_data.data.numberdata[0].displayname)
            };
            $.each(schema_current_data.data.groupdata, function(index, val) {
                delete val.optionalItems
            });
            data.data = JSON.stringify(schema_current_data.data);
            data.schemaid = schema_current_data.schemaid;
            if (extcolumn) {
                data.extcolumn = JSON.stringify(extcolumn);                
            };
            data.filteroperator = JSON.stringify(controller_data.filterColumn);
            data.tablemeta = $.extend(true, $.extend(true,[],table_meta), meta_convert).join();
            // data.tablemeta = table_meta.join();
            var deferedObject = commonPost(url,fun,errfun,datatype,data);            

            deferedObject.then(function(){
                $('#hidden-table-info').DataTable({
                    "oLanguage": {
                        "sProcessing":   "处理中...",
                        "sLengthMenu":   "显示 _MENU_ 项结果",
                        "sZeroRecords":  "没有匹配结果",
                        "sInfo":         "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                        "sInfoEmpty":    "显示第 0 至 0 项结果，共 0 项",
                        "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                        "sInfoPostFix":  "",
                        "sSearch":       "搜索:",
                        "sUrl":          "",
                        "sEmptyTable":     "表中数据为空",
                        "sLoadingRecords": "载入中...",
                        "sInfoThousands":  ",",
                        "oPaginate": {
                            "sFirst":    "首页",
                            "sPrevious": "上页",
                            "sNext":     "下页",
                            "sLast":     "末页"
                        },
                        "oAria": {
                            "sSortAscending":  ": 以升序排列此列",
                            "sSortDescending": ": 以降序排列此列"
                        }
                    },
                })
                // $('#hidden-table-info').dataTable();
                // $('#hidden-table-info').DataTable().destroy();
                // $('#hidden-table-info').dataTable()
            }, function(){
                console.log("fail")
            }).then(function(){
                console.log("thenthen");
            }, function(){console.log("thenthen")})
        }

        var drawTable = function(){
            queryForForm(schema_current_data);
        }

        var renderTable = function (meta_data,data) {
            $(".adv-table").html(
                $("#tableTemplate").render()
            );
            $( "#tableTheadTemplateTarget" ).html(
                $( "#tableTheadTemplate" ).render( meta_data )
            );
            if (data.type=="plain") {
                $( "#tableTdTemplateTarget" ).html(
                    $( "#tableTdTemplate" ).render( data.dataList )
                );
            } else if (data.type=="object") {
                var render_data = data.dataList;
                var columns = [];
                $.each(meta_data, function(index, val) {
                    var that = val;
                    $.each(displayNameMap, function(index, val) {
                        if(that==val){
                            columns.push(index)
                        }
                    });
                     /* iterate through array or object */
                });
                var data_outer_list = []
                $.each(data.dataList, function(index, val) {
                    var data_inner_list = []
                    var that = val;
                    $.each(columns, function(index, val) {
                        data_inner_list.push(that[val])
                    });
                    data_outer_list.push(data_inner_list)
                });
                $( "#tableTdTemplateTarget" ).html(
                    $( "#tableTdTemplate" ).render( data_outer_list )
                );
                // $('.adv-table table').dataTable( {
                //     "aaData": render_data,
                //     "aoColumns": columns
                // } );
            };

        }
       
        // function commonPost(url,fun,errfun,datatype,data,async){
        //   if (!datatype) {
        //     datatype="text"
        //   };
        //   if (!async) {
        //     async = false;
        //   };
        //   $.ajax({
        //       url:url,
        //       dataType:datatype,
        //       async:async,
        //       type: "POST",
        //       success:fun,
        //       data:data
        //   }).fail(
        //       errfun
        //   )
        // }

        /**
        filterModalModule
        **/
        var initfilterModal = function (data) {
            $( "#filterModal" ).html(
                $( "#filterModalTemplate" ).render( data )
            );
        }

        var showModal = function (domSelector) {
            $(domSelector).one('show.bs.modal', function (e) {
                if (domSelector=='#filterModal'){
                    initfilterModal(schema_current_data.data);
                };
            })
            $(domSelector).one('shown.bs.modal', function (e) {
                if (domSelector=='#filterModal'){
                    $("#filterTags").tagsInput({
                        width:'auto',
                        interactive:false,
                        onAddTag:function (value) {
                            console.log(this);
                        },
                        onRemoveTag:function (value) {
                            delete _global_filter_temp[value];
                            controller_data.filter = _global_filter_temp;
                        }
                    });
                    $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii'});
                    $('#filterTags').importTags('');
                    _global_filter_temp={};
                    var filterObjectArray = controller_data.filterColumn;
                    $.each(filterObjectArray, function(index, val) {
                        var filterObject = val;
                        var column =filterObject.itemName;
                        var operator = filterObject.operator;
                        var comparevalue = filterObject.value;
                        var displayName = filterObject.displayName;
                        var valueKey = displayName+operator+comparevalue;
                        _global_filter_temp[valueKey]=val;
                        $('#filterTags').addTag(valueKey);                      
                    });
                    controller_data.filter = _global_filter_temp;
                }
            })
            $(domSelector).modal('show');
        }

        $(document).ready(function() {
            // layer.load(2);
            $(document).ajaxError(function(event, xhr, settings, thrownError) {
                /* Stuff to do when an AJAX call returns an error */;
                if(xhr.status === 401){
                    location.href="${base_path}/"
                }
            });
            initSchema();

            $("#groupFilterModal").on("click",".modalgroupfiltersave",function () {
                var checkedGroupFilter = $(".groupFilterInput:visible:checked");
                if(checkedGroupFilter.length==0){
                    $.each(controller_data.groupDataDetail, function(index, val) {
                         delete val.msourceElement["hide"]
                         delete val.msourceElement["checked"]
                    });
                } else {
                    var columnname = $(".groupFilterInput:visible:checked").attr("data-value");
                    $.each(controller_data.groupDataDetail, function(index, val) {
                         if(val.msourceElement.field==columnname){
                            val.msourceElement["hide"] = 0;
                            val.msourceElement["checked"]=true;
                         } else {
                            val.msourceElement["hide"] = 1;
                            delete val.msourceElement["checked"]
                         }
                    });
                    memberArray = [];
                    member_id_array=[];
                    var memberInputCheck = $(".groupOptions:visible input:checked");
                    $.each(memberInputCheck, function(index, val) {
                        var id = $(val).attr("data-value");
                        var displayname = $(val).attr("data-displayname");
                        memberArray.push({"id":id,"displayname":displayname})
                        member_id_array.push(id)
                    });
                    $.each(controller_data.groupDataDetail, function(index, val) {
                        if (val.msourceElement.field==columnname) {
                            $.each(val.mmemberList, function(index, val) {
                                if (member_id_array.indexOf(String(val.id))>=0) {
                                    val.checked = true;
                                } else {
                                    delete val["checked"]
                                }
                            });
                        };
                    });

                }
                $('#groupFilterModal').modal('hide');
                drawTable();
            })

            $(document).on('click', ".filterButton", function(event){
                event.preventDefault();
                /* Act on the event */
                showModal('#filterModal')                    
            })

            //以下几个事件绑定是filter模块的功能
            //1、点击添加新filter按钮
            $("#filterModal").on('click',"#addfilter", function(event) {
                event.preventDefault();
                var filterObject = {};
                var column = $(".column").val();
                var columnDisplay = $(".column option:selected").text();
                var operator = $(".opgroup:visible").val();
                var comparevalue = '';
                $(".comparevalue").each(function(index, val) {
                     var that = $(this);
                     if (that.is(':visible')) {
                        comparevalue =  that.val();
                };
                     
                });;
                var valueKey = columnDisplay+operator+comparevalue;
                filterObject.itemName = column;
                filterObject.operator = operator;
                if(operator=="like"){
                    filterObject.value = "%"+comparevalue+"%";
                } else {
                    filterObject.value = comparevalue;
                }
                filterObject.displayName = columnDisplay;
                $('#filterTags').addTag(valueKey);
                // $('#filterTags'+this.uuid).addTag(valueKey);
                _global_filter_temp[valueKey]=filterObject;
                controller_data.filter = _global_filter_temp;
            });

            //2、日期与数值类型数据的切换
            $("#filterModal").on('change', 'select', function(event) {
                event.preventDefault();
                /* Act on the event */
                var property = $(".column option:selected").attr('dtype');
                property = Number(property);
                if(property==0||property+1==0){
                    $('#valueinput').show('fast');
                    $('#caldateinput').hide('fast');
                    if(property==0){
                        $(".operator").show('fast');
                        $(".likeOperator").hide('fast');
                    } else {
                        $(".operator").hide('fast');
                        $(".likeOperator").show('fast');
                    }
                } else {
                    $('#caldateinput').show('fast');
                    $('#valueinput').hide('fast');
                }
            });

            //3、点击保存按钮
            //以上1、2、3为filter的共三个功能
            $("#filterModal").on("click",".modalfiltersave",function () {
                var filterColumn = [];
                $('#filterModal').modal('hide')
                for(f in _global_filter_temp){
                    filterColumn.push(_global_filter_temp[f]);
                }
                controller_data.filterColumn = filterColumn;
                controller_data.filter = _global_filter_temp;
                drawTable();
            })

        } );
    </script>
</@script>