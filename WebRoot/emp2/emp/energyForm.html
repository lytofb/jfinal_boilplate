<#include "/emp2/common/_layout.html"/>
    <@css>
    <!--tags input-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.css" />
    <!--pickers css-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datepicker/css/datepicker-custom.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-timepicker/css/timepicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
    <!-- table -->
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_page.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_table.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/data-tables/DT_bootstrap.css" rel="stylesheet"> 
    </@css>
	<@layout>
    <style type="text/css">
    .icheck .single-row {
      width: auto;
    }
    .radio, .checkbox {
        padding-left: 0px;
    }
    .odd {
        background-color: #F9F9F9!important;
    }

    </style>
	<div class="wrapper">
            <div class="row">
                <div class="col-sm-12">
                    <section class="panel">
                        <header class="panel-heading" style="position: relative">
                            零售概况
                        <div style="position:absolute;top: 8px;right: 10px">
                        <span class="pull-right">
                         </span>
                         </div>
                        </header>
                        <div class="panel-body">
                            <#include "/emp2/common/cwtpTableComp.html"/>
                            <#include "/emp2/common/cwtpTableTemplateComp.html"/>
                            <div class="adv-table">
                            <!--
                            <table class="display table table-bordered" id="hidden-table-info">
                            <thead>
                            <tr id="tableTheadTemplateTarget">
                            </tr>
                            </thead>
                            <tbody id="tableTdTemplateTarget">
                            </tbody>
                            </table>
                            -->
                            </div>
                        </div>
                    </section>
                </div>
            </div>	
	</div>
	 <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="userModel" class="modal fade">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                       <h4 class="modal-title">关联用户</h4>
                   </div>
                   <div class="modal-body">
                       <form role="form" id="form" action="/role/editUserRel"> 
          		         <input type="hidden" name="roleid" id=roleid>
                           <div class="checkbox"> <button type="button" id="userModelClick" class="btn btn-primary">提交</button></div>
                       </form>
                   </div>
                   		<div class="chart"><div id="chartB"></div></div>
               </div>
           </div>
       </div> 
	
	
	
    <#include "/emp2/common/filterComp.html"/>
    <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="filterModal">
    </div>

    </@layout>
<@script>
<script src="${base_path}/emp2/js/jsrender.js" type="text/javascript"></script>
<script src="${base_path}/js/nnitScript.js" type="text/javascript"></script>
<!-- dataTable -->

<script type="text/javascript"
    src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.js"></script>
<!-- 
<script type="text/javascript"
    src="${base_path}/emp2/js/advanced-datatable/js/jquery.dataTables.js"></script>
 -->
<script type="text/javascript"
    src="${base_path}/emp2/js/data-tables/DT_bootstrap.js"></script>
<!--tags input-->
<script src="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.js"></script>
<!--pickers plugins-->
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<script type="text/javascript">
var schema_data = {};
var schema_current_data = {};
var form_data = [];
var meta_data = [];
//var meta_data = [{"displayName":"区县","columname":"hehe"},{"displayName":"重钢","columname":"hehe"},{"displayName":"天泰","columname":"hehe"},{"displayName":"电耗","columname":"hehe"}];
var displayNameMap = {};
var _global_filter_temp={};
var schema_data_seq = ${schema_seq!0};
var controller_data = {};

var initControllerData = function(){
    //根据schema以及cwtp初始化controller
    controller_data = $.extend(true,{},schema_current_data.data);
    controller_data.filter = _global_filter_temp;
    controller_data.filterColumn = [];
}

var initDisplayNameMap = function () {
    var groupData = controller_data.groupdata;
    var numberData = controller_data.numberdata;
    $.each(groupData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
    $.each(numberData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
}

var setMetaData = function () {
    var groupData = controller_data.groupdata;
    var numberData = controller_data.numberdata;
    $.each(groupData, function(index, val) {
         /* iterate through array or object */
         var meta = {};
         meta.displayName = val.displayname;
         meta.columname = val.columname;
         meta_data.push(meta);
    });
    $.each(numberData, function(index, val) {
         /* iterate through array or object */
         var meta = {};
         meta.displayName = val.displayname;
         meta.columname = val.columname;
         meta_data.push(meta);
    });
}
var initSchema = function () {
        var url = '${base_path}/eco/getSchema';
        var fun = function (data) {
            schema_data = data;
            schema_current_data =data.schema_list[schema_data_seq];            
        };
        var errfun = function () {};
        var datatype = 'json';
        var data = {'userId':${userid},'token':1,'magnitude':100};
        var deferedObject = commonPost(url,fun,errfun,datatype,data);
        deferedObject.then(function(){
            initControllerData();
            setMetaData();
            initDisplayNameMap();
            initSchemaSelector();
        }, function(){
            console.log("fail")
        }).then(function(){console.log("thenthen")}, function(){console.log("thenthen")})
}

var renderTable = function (form_data,meta_data) {
    $( ".adv-table" ).html(
        $( "#cwtpTableTemplateComp" ).render()
    );

    $( "#tableTdTemplateTarget" ).html(
        $( "#cwtpTableTdTemplate" ).render( form_data )
    );

    $( "#tableTheadTemplateTarget" ).html(
        $( "#cwtpTableTheadTemplate" ).render( meta_data )
    );

}

var renderFromBackend = function () {
    $('#hidden-table-info').dataTable({
    	"oLanguage": {
    		"sProcessing":   "处理中...",
    		"sLengthMenu":   "显示 _MENU_ 项结果",
    		"sZeroRecords":  "没有匹配结果",
    		"sInfo":         "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
    		"sInfoEmpty":    "显示第 0 至 0 项结果，共 0 项",
    		"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
    		"sInfoPostFix":  "",
    		"sSearch":       "搜索:",
    		"sUrl":          "",
    		"sEmptyTable":     "表中数据为空",
    		"sLoadingRecords": "载入中...",
    		"sInfoThousands":  ",",
    		"oPaginate": {
    			"sFirst":    "首页",
    			"sPrevious": "上页",
    			"sNext":     "下页",
    			"sLast":     "末页"
    		},
    		"oAria": {
    			"sSortAscending":  ": 以升序排列此列",
    			"sSortDescending": ": 以降序排列此列"
    		}
        },
       // "bRetrieve": true,
       "bFilter": false,
       // "aoColumnDefs": [
       //    { "bSortable": false, "aTargets": [ 0 ] }
       // ],
       "processing": true,
        "serverSide": true,
        // "bSorting": [[1, 'asc']],
        // "paging": true,
        "ajax": {
            "url": "${base_path}/eco/getDataForDraw",
            "type": "POST",
            "data": function ( d ) {
                var filter = {};
                var schema = [];
                $.each(meta_data, function(index, val) {
                     /* iterate through array or object */
                     schema.push(val.columname);
                });
                filter.schema = schema;
                filter.filterColumn = controller_data.filterColumn;
                d.filter = JSON.stringify(filter);
                d.userId = ${userid};
                d.token = 1;
                d.schemaid = schema_current_data.schemaid;
            }
        }
      });


}

var drawTable = function(){
    renderTable(form_data,meta_data);
    renderFromBackend();
}
var energyForm = function (data) {
    var url = '${base_path}/eco/getFormData';
    var fun = function (data) {
        schema_data = data;
        schema_current_data =data.schema_list[schema_data_seq];            
    };
    var errfun = function () {};
    var datatype = 'json';
    commonPost(url,fun,errfun,datatype,data);

}
jQuery(document).ready(function($) {
    $(document).ajaxError(function(event, xhr, settings, thrownError) {
        /* Stuff to do when an AJAX call returns an error */;
        if(xhr.status === 401){
            location.href="${base_path}/"
        }
    });
	var data = {};
	var extcolumn = {"numbercolumn":"energyvalue",
 				     "columnname":"energycode",
 				    "columoptions":["原煤","天然气(气态)","电力","汽油"], 
					};
	var tempdata = {"groupdata":[{"columname":"districtname","displayname":"区县名称","magnitude":"29","selectable":1},
								 {"columname":"energycode","displayname":"能源编码","magnitude":"29","selectable":1}], 
		            "numberdata":[{"columname":"energyvalue","displayname":"能源值","property":"0"}]};
	data.userId = 1;
	data.token = 1;
	data.schemaid = 15;

	data.extcolumn = JSON.stringify(extcolumn);
	data.data = JSON.stringify(tempdata);
	
	energyForm(data);
});

</script>
</@script>