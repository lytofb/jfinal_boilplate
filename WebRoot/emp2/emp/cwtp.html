<#include "/emp2/common/_layout.html"/>
    <@css>
    <!--icheck-->
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/minimal.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/red.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/green.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/blue.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/yellow.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/iCheck/skins/minimal/purple.css" rel="stylesheet">
    <!-- table -->
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_page.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_table.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/data-tables/DT_bootstrap.css" rel="stylesheet"> 
    <!--tags input-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.css" />
    <!--pickers css-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datepicker/css/datepicker-custom.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-timepicker/css/timepicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />

    </@css>
	<@layout>
    <style type="text/css">
    .icheck .single-row {
      width: auto;
    }
    .radio, .checkbox {
        padding-left: 0px;
    }
    .odd {
        background-color: #F9F9F9!important;
    }

    </style>

	<div class="wrapper">
            <div class="row">
                <div class="col-sm-12">
                    <section class="panel">
                        <header class="panel-heading" style="position: relative">
                            环比排名
                        <div style="position:absolute;top: 8px;right: 10px">
                        <span class="pull-right">
                             <button class="btn btn-default filterButton">
                                <i class="fa fa-filter"></i>
                            </button>                            
                             <button class="btn btn-default cwtpGroupFilterButton">
                                <i class="fa fa-align-justify"></i>
                            </button>
                            <!--                     
                             <button class="btn btn-default">
                                <i class="fa fa-eye"></i>
                            </button>
                            -->                           
                         </span>
                         </div>
                        </header>
                        <div class="panel-body">
                            <#include "/emp2/common/cwtpTableComp.html"/>
                            <#include "/emp2/common/cwtpTableTemplateComp.html"/>
                            <div class="missedchart">
                                
                            </div>
                            <div class="adv-table">
                            <!--
                            <table class="display table table-bordered" id="hidden-table-info">
                            <thead>
                            <tr id="tableTheadTemplateTarget">
                            </tr>
                            </thead>
                            <tbody id="tableTdTemplateTarget">
                            </tbody>
                            </table>
                            -->
                            </div>
                        </div>
                    </section>
                </div>
            </div>	
	</div>
    <#include "/emp2/common/cwtpGroupFilterComp.html"/>
    <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="xxModal">
    </div>
    <#include "/emp2/common/filterComp.html"/>
    <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="filterModal">
    </div>

    </@layout>
<@script>
<!--icheck -->
<script src="${base_path}/emp2/js/iCheck/jquery.icheck.js"></script>
<script src="${base_path}/emp2/js/icheck-init.js"></script>
<script src="${base_path}/emp2/js/jsrender.js" type="text/javascript"></script>
<script src="${base_path}/emp2/js/nnitScript.js" type="text/javascript"></script>
<!-- dataTable -->
<script type="text/javascript"
    src="${base_path}/emp2/js/jquery.dataTables110.js"></script>
    <!--
<script type="text/javascript"
    src="${base_path}/emp2/js/advanced-datatable/js/jquery.dataTables.js"></script>
    -->
<script type="text/javascript"
    src="${base_path}/emp2/js/data-tables/DT_bootstrap.js"></script>
<script type="text/javascript"
    src="${base_path}/emp2/js/dynamic_table_init.js"></script>
<!--tags input-->
<script src="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.js"></script>
<!--pickers plugins-->
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<!-- popupoverlay  -->
<script type="text/javascript">

var schema_data = {};
var schema_current_data = {};
var form_data = [];
var meta_data = [];
var displayNameMap = {};
var cwtp = {};
var session_schema_id = ${schema_id!-1};

var _global_filter_temp={};
var _global_initFlag = undefined;
var controller_data = {};


//dataTable filterinput style
$.fn.dataTableExt.oStdClasses["sFilterInput"] = "form-control";

var mockInitCwtp = function () {
    //初始化cwtp
    var filter = [];
    var groupFilter = {};
    groupFilter.element = controller_data.groupdata[0].columname;
    groupFilter.value = [controller_data.groupdata[0].optionalItems[0],controller_data.groupdata[0].optionalItems[1]];
    var sortGroup = {};
    sortGroup.element = controller_data.groupdata[1].columname;
    sortGroup.sortType = "asc";
    // sortGroup.topNum = "10";
    sortNumber = {"element":controller_data.numberdata[0].columname}

    cwtp.filter = filter;
    cwtp.groupFilter = groupFilter;
    cwtp.sortGroup = sortGroup;
    cwtp.sortNumber = sortNumber;

    cwtp.sortGroup.displayName=controller_data.groupdata[1].displayname;
    cwtp.sortNumber.displayName = controller_data.numberdata[0].displayname;
    return cwtp;
}
var mockInitResult = function () {
    form_data = [{"sortElement":"a","groupFirst":"2987","groupSecond":"5349","increaseRate":56}];
}

var initDisplayNameMap = function () {
    var groupData = controller_data.groupdata;
    var numberData = controller_data.numberdata;
    $.each(groupData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
    $.each(numberData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
}

var initSchema = function () {
        var url = '${base_path}/eco/getSchema';
        var fun = function (data) {
            window.schema_data =data;
            window.schema_dict ={};
            schema_data.schema_list.map(function(object){schema_dict[object.schemaid]=object})
            if(session_schema_id==-1){
                session_schema_id = window.schema_data.schema_list[0].schemaid
            }
            schema_current_data =window.schema_dict[session_schema_id];
        };
        var errfun = function () {};
        var datatype = 'json';
        var data = {'userId':${userid!1},'token':1,'magnitude':200};
        var deferedObject = commonPost(url,fun,errfun,datatype,data);
        deferedObject.then(function(){
            initControllerData();
            controller_data.cwtp = mockInitCwtp();
            setMetaData();
            initDisplayNameMap();
            initSchemaSelector();
        }, function(){
            console.log("fail")
        }).then(function(){getCwtpData(true)}, function(){console.log("thenthen")})
}

var initControllerData = function () {
    //根据schema以及cwtp初始化controller
    controller_data = $.extend(true,{},schema_current_data.data);
    controller_data.cwtp = cwtp;
}

var setMetaData = function () {
    meta_data=[];
    meta_data.push({displayName:cwtp.sortGroup.displayName});
    meta_data.push({displayName:cwtp.groupFilter.value[0]});
    meta_data.push({displayName:cwtp.groupFilter.value[1]});
    meta_data.push({displayName:cwtp.sortNumber.displayName+"增长率（%）"});
}

var setCwtpByGui = function (onFilterCall) {
    var columname = undefined;
    var groupFilter = undefined;
    var groupInput = undefined;
    var sortNumberInput = undefined;
    var sortTypeInput = "desc";
    var rangeSelector = 10;
    var groupFilterDetail = [];
    $(".groupFilterInput").each(function(index,val){
        if(this.checked){
            columname = $(this).attr("data-value");
            console.log(columname)
            groupFilter = columname;
        }
    })

    $(".groupFilterDetailInput:visible").each(function(index,val){
        if(this.checked){
            columname = $(this).attr("data-value");
            console.log(columname)
            groupFilterDetail.push(columname);
        }
    })

    $(".groupInput").each(function(index,val){
        if($(this).prop("checked")){
            columname = $(this).attr("data-value");
            console.log(columname)
            groupInput = columname;
        }
    })

    $(".sortNumberInput").each(function(index,val){
        if($(this).prop("checked")){
            columname = $(this).attr("data-value");
            console.log(columname)
            sortNumberInput = columname;
        }
    })

    $(".sortTypeInput").each(function(index,val){
        if($(this).prop("checked")){
            columname = $(this).attr("data-value");
            console.log(columname)
            sortTypeInput = columname;
        }
    })

    rangeSelector = $(".rangeSelector").val()

    cwtp.groupFilter.element = groupFilter;
    cwtp.groupFilter.value = groupFilterDetail;
    cwtp.sortGroup.element = groupInput;
    cwtp.sortGroup.displayName = displayNameMap[groupInput];
    cwtp.sortGroup.sortType = sortTypeInput;
    cwtp.sortGroup.topNum = rangeSelector;
    cwtp.sortNumber.element = sortNumberInput;
    cwtp.sortNumber.displayName = displayNameMap[sortNumberInput];
}


var renderTable = function (form_data,meta_data) {
    $( ".adv-table" ).html(
        $( "#cwtpTableTemplateComp" ).render()
    );

    $( "#tableTdTemplateTarget" ).html(
        $( "#cwtpTableTdTemplate" ).render( form_data )
    );

    $( "#tableTheadTemplateTarget" ).html(
        $( "#cwtpTableTheadTemplate" ).render( meta_data )
    );

}

var getCwtpData = function (initFlag) {
    var schema = schema_current_data.data
    var url = '${base_path}/eco/getCwtpData';
    var fun = function (data) {
        if(data.msg_code =="0x200001"){
            form_data = data.dataArray;
            setMetaData();
            renderTable(form_data,meta_data);
            //initDynamicTable();
            initHiddenTable();
        } else {
            console.log(data.msg_code);
        }
    };
    if(!initFlag){
        setCwtpByGui();        
    }
    var datatype = 'json';
    var data = {'userId':${userid!1},'token':1,schemaid:schema_current_data.schemaid,sumvalue:1};
    data.cwtp = JSON.stringify(cwtp);
    var deferedObject = commonPost(url,fun,undefined,datatype,data,true,true);
}


var initfilterModal = function (data) {
    $( "#filterModal" ).html(
        $( "#filterModalTemplate" ).render( data )
    );
}

var showModal = function (domSelector) {
    $(domSelector).one('show.bs.modal', function (e) {
        if (domSelector='#filterModal'){
            initfilterModal(schema_current_data.data);
        };
    })
    $(domSelector).modal('show');
    $(domSelector).one('shown.bs.modal', function (e) {
        if (domSelector='#filterModal'){
            $("#filterTags").tagsInput({
                width:'auto',
                interactive:false,
                onAddTag:function (value) {
                    console.log(this);
                },
                onRemoveTag:function (value) {
                    delete _global_filter_temp[value];
                }
            });
            $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii'});
            $('#filterTags').importTags('');
            _global_filter_temp={};
            var filterObjectArray = cwtp.filter;
            $.each(filterObjectArray, function(index, val) {
                var filterObject = val;
                var column =filterObject.itemName;
                var operator = filterObject.operator;
                var comparevalue = filterObject.value;
                var displayName = filterObject.displayName;
                var valueKey = displayName+operator+comparevalue;
                _global_filter_temp[valueKey]=val;
                $('#filterTags').addTag(valueKey);                      
            });
        }
    })

}

var initcwtpGroupFilterModal = function (data) {
    $( "#xxModal" ).html(
        $( "#cwtpGroupFilterTemplate" ).render(data)
    );
    initIcheck();
}

var initifClickBind = function () {
    $(".groupFilter input").on('ifChecked', function(event) {
        event.preventDefault();
        /* Act on the event */
        var col = $(this).attr("data-value");
        $(this).parents(".icheck").find(".groupFilter").hide();
        $(this).parents(".groupFilter").show();
        $("."+col).show();
        // $(".groupOptions").find("."+col).show();
    });

    $(".groupFilter input").on('ifUnchecked', function(event) {
        event.preventDefault();
        /* Act on the event */
        var col = $(this).attr("data-value");
        $(this).parents(".icheck").find(".groupFilter").show();
        $("."+col).hide();
        // $(".groupOptions").find("."+col).hide();
    });    
}

var initHiddenTable = function () {
    var oTable = $('#hidden-table-info').dataTable( {
    	"oLanguage": {
    		"sProcessing":   "处理中...",
    		"sLengthMenu":   "显示 _MENU_ 项结果",
    		"sZeroRecords":  "没有匹配结果",
    		"sInfo":         "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
    		"sInfoEmpty":    "显示第 0 至 0 项结果，共 0 项",
    		"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
    		"sInfoPostFix":  "",
    		"sSearch":       "搜索:",
    		"sUrl":          "",
    		"sEmptyTable":     "表中数据为空",
    		"sLoadingRecords": "载入中...",
    		"sInfoThousands":  ",",
    		"oPaginate": {
    			"sFirst":    "首页",
    			"sPrevious": "上页",
    			"sNext":     "下页",
    			"sLast":     "末页"
    		},
    		"oAria": {
    			"sSortAscending":  ": 以升序排列此列",
    			"sSortDescending": ": 以降序排列此列"
    		}
        },
        "bRetrieve": true,
        "aaSorting": [[0, 'asc']],
        "createdRow": function( row, data, dataIndex ) {
            $(row).on("click",function(){
                console.log(dataIndex);
                console.log(data[0]);
                getChartData(data[0],controller_data.cwtp);
            });
        },
    });    
}

var getChartData = function(column_name,cwtp){
    var fun = function(data){
        if(data.msg_code =="0x200001"){
            drawChartOnDom(".missedchart",data.data.datacontent.xAxis.categories,data.data.datacontent.series,200)
        }
    };
    var error_callback = function(){};
    var url = 'getChartData';
    var datatype = 'json';
    var data = {};
    data.userId = 3;
    data.token = 1;
    data.schemaid = 1;
    var datacontent = {};
    var groupFilter = cwtp.groupFilter;
    var filterGroupColumnArray = [];
    var groupcolumn = [cwtp.groupFilter.element,cwtp.sortGroup.element];
    var numbercolumn = [{"element":cwtp.sortNumber.element,"functionName":"sum"}];
    var filetercolumn = [{"itemName":cwtp.sortGroup.element,"operator":"=","value":column_name,"displayName":"金额"}];
    if (column_name=="总和") {
        filetercolumn = []
    }
    var fileterGroupColumn = [];
    $.each(groupFilter.value, function(index, val) {
        filterGroupColumnArray.push({"element":groupFilter.element,"value":val})
    });
    datacontent.filterGroupColumnArray = filterGroupColumnArray;
    datacontent.groupcolumn = groupcolumn;
    datacontent.filetercolumn = filetercolumn;
    datacontent.fileterGroupColumn = fileterGroupColumn;
    datacontent.numbercolumn = numbercolumn;
    data.data = JSON.stringify({"datatype":2,"datacontent":datacontent})
    var deferred = commonPost(url,fun,error_callback,datatype,data);
    return deferred;
}

var drawChartOnDom = function(domSelector,categories,series,height,width){
    var HCoption = 
    {
        chart:{
            type:"column",
            height:height,
        },
        exporting:{
            enabled:false   
        },
        title: {
            text: null,
            x: -20 //center
        },
        subtitle: {
            text: null,
            x: -20
        },
        xAxis: {
            categories: categories
        },
        yAxis: {
            title: {
                text:null
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: null,
            positioner: function () {
                return { x: 80, y: 0 };
            },
            crosshairs: {
                width: 2,
                color: 'gray',
                dashStyle: 'shortdot'
            }
        },
        legend: {
            enabled:true,
            borderWidth: 0
        },
        credits: {  
              enabled: false  
        },
        series: series      
    };
    // if (categories) {
    //     HCoption.categories = categories;
    // };
    // if (series){
    //     HCoption.series = series;
    // };
    if(width){
        HCoption.chart.width=width;
    };
    $(domSelector).highcharts(HCoption);
}

jQuery(document).ready(function($) {
    $(document).ajaxError(function(event, xhr, settings, thrownError) {
        /* Stuff to do when an AJAX call returns an error */;
        if(xhr.status === 401){
            location.href="${base_path}/"
        }
    });
    
    initSchema();
    // mockInitResult();
    renderTable(form_data,meta_data);
    //initDynamicTable();
    // initHiddenTable();
    $(".filterButton").on('click', function(event) {
        event.preventDefault();
        /* Act on the event */
        showModal('#filterModal')
    });

    $(".cwtpGroupFilterButton").on('click', function(event) {
        event.preventDefault();
        var beforeShow = function(){
            initcwtpGroupFilterModal(controller_data);
        };
        var afterShow = function(){
        };
        $("#xxModal").one('show.bs.modal', function (e) {
            beforeShow();
            initifClickBind();
        })
        $("#xxModal").modal("show");
        $("#xxModal").one('shown.bs.modal', function (e) {
            afterShow();
        })
    });

    //以下几个事件绑定是filter模块的功能
    //1、点击添加新filter按钮
    $("#filterModal").on('click',"#addfilter", function(event) {
        event.preventDefault();
        var filterObject = {};
        var column = $(".column").val();
        var columnDisplay = $(".column option:selected").text();
        var operator = $(".opgroup:visible").val();
        var comparevalue = '';
        $(".comparevalue").each(function(index, val) {
             /* iterate through array or object */
             var that = $(this);
             if (that.is(':visible')) {
                comparevalue =  that.val();
        };
             
        });;
        var valueKey = columnDisplay+operator+comparevalue;
        filterObject.itemName = column;
        filterObject.operator = operator;
        if(operator=="like"){
            filterObject.value = "%"+comparevalue+"%";
        } else {
            filterObject.value = comparevalue;
        }
        filterObject.displayName = columnDisplay;
        $('#filterTags').addTag(valueKey);
        // $('#filterTags'+this.uuid).addTag(valueKey);
        _global_filter_temp[valueKey]=filterObject;
    });

    //2、日期与数值类型数据的切换
    $("#filterModal").on('change', 'select', function(event) {
        event.preventDefault();
        /* Act on the event */
        var property = $(".column option:selected").attr('dtype');
        property = Number(property);
        if(property==0||property+1==0){
            $('#valueinput').show('fast');
            $('#caldateinput').hide('fast');
            if(property==0){
                $(".operator").show('fast');
                $(".likeOperator").hide('fast');
            } else {
                $(".operator").hide('fast');
                $(".likeOperator").show('fast');
            }
        } else {
            $('#caldateinput').show('fast');
            $('#valueinput').hide('fast');
        }
    });

    //3、点击保存按钮
    //以上1、2、3为filter的共三个功能
    $("#filterModal").on("click",".modalfiltersave",function () {
        var filterColumn = [];
        $('#filterModal').modal('hide')
        for(f in _global_filter_temp){
            filterColumn.push(_global_filter_temp[f]);
        }
        cwtp.filter = filterColumn;
        getCwtpData(true);
    })

    $("#xxModal").on("click",".modalsave",function () {
        $('#xxModal').modal('hide')
        getCwtpData();
        // setMetaData();
        // renderTable(form_data,meta_data);
        // initDynamicTable();
        // initHiddenTable();
        console.log("!-_-?");
    })
})
</script>
</@script>
    