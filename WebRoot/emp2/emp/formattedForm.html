<#include "/emp2/common/_layout.html"/>
    <@css>
    <!--tags input-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.css" />
    <!--pickers css-->
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datepicker/css/datepicker-custom.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-timepicker/css/timepicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-colorpicker/css/colorpicker.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
    <link rel="stylesheet" type="text/css" href="${base_path}/emp2/js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
    <!-- table -->
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_page.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/advanced-datatable/css/demo_table.css" rel="stylesheet">
    <link href="${base_path}/emp2/js/data-tables/DT_bootstrap.css" rel="stylesheet"> 
    </@css>
	<@layout>
    <style type="text/css">
    .icheck .single-row {
      width: auto;
    }
    .radio, .checkbox {
        padding-left: 0px;
    }
    .odd {
        background-color: #F9F9F9!important;
    }

    </style>
	<div class="wrapper">
            <div class="row">
                <div class="col-sm-12">
                    <section class="panel">
                        <header class="panel-heading" style="position: relative">
                            零售概况
                        <div style="position:absolute;top: 8px;right: 10px">
                        <span class="pull-right">
                             <button class="btn btn-default filterButton">
                                <i class="fa fa-filter"></i>
                            </button>                            
                        </span>
                        </div>
                        </header>
                        <div class="panel-body">
                            <#include "/emp2/common/cwtpTableComp.html"/>
                            <#include "/emp2/common/cwtpTableTemplateComp.html"/>
                            <div class="adv-table">
                            </div>
                        </div>
                    </section>
                </div>
            </div>	
	</div>
    <#include "/emp2/common/filterComp.html"/>
    <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="filterModal">
    </div>

    </@layout>
<@script>
<script src="${base_path}/emp2/js/jsrender.js" type="text/javascript"></script>
<script src="${base_path}/emp2/js/nnitScript.js" type="text/javascript"></script>
<!-- dataTable -->

<script type="text/javascript"
    src="${base_path}/emp2/js/jquery.dataTables110.js"></script>
    <!--
<script type="text/javascript"
    src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.js"></script>
    -->
<!-- 
<script type="text/javascript"
    src="${base_path}/emp2/js/advanced-datatable/js/jquery.dataTables.js"></script>
 -->
<script type="text/javascript"
    src="${base_path}/emp2/js/data-tables/DT_bootstrap.js"></script>
<!--tags input-->
<script src="${base_path}/emp2/js/jquery-tags-input/jquery.tagsinput.js"></script>
<!--pickers plugins-->
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="${base_path}/emp2/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<script type="text/javascript">
var schema_data = {};
var schema_current_data = {};
var form_data = [];
var meta_data = [];
var displayNameMap = {};
var _global_filter_temp={};
var session_schema_id = ${schema_id!-1};
var controller_data = {};

var initControllerData = function(){
    //根据schema以及cwtp初始化controller
    controller_data = $.extend(true,{},schema_current_data.data);
    controller_data.filter = _global_filter_temp;
    controller_data.filterColumn = [];
}

var initDisplayNameMap = function () {
    var groupData = controller_data.groupdata;
    var numberData = controller_data.numberdata;
    $.each(groupData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
    $.each(numberData, function(index, val) {
         /* iterate through array or object */
         displayNameMap[val.columname] = val.displayname;
    });
}

var setMetaData = function () {
    var groupData = controller_data.groupdata;
    var numberData = controller_data.numberdata;
    $.each(groupData, function(index, val) {
         /* iterate through array or object */
         var meta = {};
         meta.displayName = val.displayname;
         meta.columname = val.columname;
         meta_data.push(meta);
    });
    $.each(numberData, function(index, val) {
         /* iterate through array or object */
         var meta = {};
         meta.displayName = val.displayname;
         meta.columname = val.columname;
         if (val.property==0) {
             meta_data.push(meta);
         };
    });
}
var initSchema = function () {
        var url = '${base_path}/eco/getSchema';
        var fun = function (data) {
            window.schema_data =data;
            window.schema_dict ={};
            schema_data.schema_list.map(function(object){schema_dict[object.schemaid]=object})
            if(session_schema_id==-1){
                session_schema_id = window.schema_data.schema_list[0].schemaid
            }
            schema_current_data =window.schema_dict[session_schema_id];
        };
        var errfun = function () {};
        var datatype = 'json';
        var data = {'userId':${userid},'token':1,'magnitude':100};
        var deferedObject = commonPost(url,fun,errfun,datatype,data);
        deferedObject.then(function(){
            initControllerData();
            setMetaData();
            initDisplayNameMap();
            initSchemaSelector();
        }, function(){
            console.log("fail")
        }).then(function(){console.log("thenthen")}, function(){console.log("thenthen")})
}

var renderTable = function (meta_data) {
    $( ".adv-table" ).html(
        $( "#cwtpTableTemplateComp" ).render()
    );

    $( "#tableTheadTemplateTarget" ).html(
        $( "#cwtpTableTheadTemplate" ).render( meta_data )
    );

}

var renderFromBackend = function () {
    $('#hidden-table-info').dataTable({
    	"oLanguage": {
    		"sProcessing":   "处理中...",
    		"sLengthMenu":   "显示 _MENU_ 项结果",
    		"sZeroRecords":  "没有匹配结果",
    		"sInfo":         "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
    		"sInfoEmpty":    "显示第 0 至 0 项结果，共 0 项",
    		"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
    		"sInfoPostFix":  "",
    		"sSearch":       "搜索:",
    		"sUrl":          "",
    		"sEmptyTable":     "表中数据为空",
    		"sLoadingRecords": "载入中...",
    		"sInfoThousands":  ",",
    		"oPaginate": {
    			"sFirst":    "首页",
    			"sPrevious": "上页",
    			"sNext":     "下页",
    			"sLast":     "末页"
    		},
    		"oAria": {
    			"sSortAscending":  ": 以升序排列此列",
    			"sSortDescending": ": 以降序排列此列"
    		}
        },
       "bFilter": false,
       "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "${base_path}/eco/getDataForDraw",
            "type": "POST",
            "data": function ( d ) {
                var filter = {};
                var schema = [];
                var getFoo = function(array){return function(object){if(object.property==0){array.push(object)}}}
                var arrayList = [];

                $.each(meta_data, function(index, val) {
                     schema.push(val.columname);
                });
                filter.schema = schema;
                filter.filterColumn = controller_data.filterColumn;
                column_info = {}
                column_info.numberdata = $.extend(true, [], controller_data.numberdata);
                column_info.numberdata.map(getFoo(arrayList));
                column_info.numberdata = arrayList;
                column_info.groupdata = $.extend(true, [], controller_data.groupdata);
                $.each(column_info.groupdata, function(index, val) {
                    delete val.optionalItems
                });
                filter.columnInfo = column_info;
                d.filter = JSON.stringify(filter);
                d.userId = ${userid};
                d.token = 1;
                d.schemaid = schema_current_data.schemaid;
                d.aggregate = 1;
            }
        }
    });
}
/**
filterModalModule
**/
var initfilterModal = function (data) {
    $( "#filterModal" ).html(
        $( "#filterModalTemplate" ).render( data )
    );
}

var showModal = function (domSelector) {
    $(domSelector).one('show.bs.modal', function (e) {
        if (domSelector=='#filterModal'){
            initfilterModal(schema_current_data.data);
        };
    })
    // $(domSelector).one('shown.bs.modal', function (e) {
    $(document).one('shown.bs.modal',domSelector, function (e) {
        if (domSelector=='#filterModal'){
            $("#filterTags").tagsInput({
                width:'auto',
                interactive:false,
                onAddTag:function (value) {
                    console.log(this);
                },
                onRemoveTag:function (value) {
                    delete _global_filter_temp[value];
                    controller_data.filter = _global_filter_temp;
                }
            });
            $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii'});
            $('#filterTags').importTags('');
            _global_filter_temp={};
            var filterObjectArray = controller_data.filterColumn;
            $.each(filterObjectArray, function(index, val) {
                var filterObject = val;
                var column =filterObject.itemName;
                var operator = filterObject.operator;
                var comparevalue = filterObject.value;
                var displayName = filterObject.displayName;
                var valueKey = displayName+operator+comparevalue;
                _global_filter_temp[valueKey]=val;
                $('#filterTags').addTag(valueKey);                      
            });
            controller_data.filter = _global_filter_temp;
        }
    })
    $(domSelector).modal('show');

}

var drawTable = function(){
    renderTable(meta_data);
    renderFromBackend();
}

jQuery(document).ready(function($) {
    $(document).ajaxError(function(event, xhr, settings, thrownError) {
        /* Stuff to do when an AJAX call returns an error */;
        if(xhr.status === 401){
            location.href="${base_path}/"
        }
    });

    initSchema();
    drawTable();
    $(".filterButton").on('click', function(event) {
        event.preventDefault();
        /* Act on the event */
        showModal('#filterModal')
    });

    //以下几个事件绑定是filter模块的功能
    //1、点击添加新filter按钮
    $("#filterModal").on('click',"#addfilter", function(event) {
        event.preventDefault();
        var filterObject = {};
        var column = $(".column").val();
        var columnDisplay = $(".column option:selected").text();
        var operator = $(".opgroup:visible").val();
        var comparevalue = '';
        $(".comparevalue").each(function(index, val) {
             var that = $(this);
             if (that.is(':visible')) {
                comparevalue =  that.val();
        };
             
        });;
        var valueKey = columnDisplay+operator+comparevalue;
        filterObject.itemName = column;
        filterObject.operator = operator;
        if(operator=="like"){
            filterObject.value = "%"+comparevalue+"%";
        } else {
            filterObject.value = comparevalue;
        }
        filterObject.displayName = columnDisplay;
        $('#filterTags').addTag(valueKey);
        // $('#filterTags'+this.uuid).addTag(valueKey);
        _global_filter_temp[valueKey]=filterObject;
        controller_data.filter = _global_filter_temp;
    });

    //2、日期与数值类型数据的切换
    $("#filterModal").on('change', 'select', function(event) {
        event.preventDefault();
        /* Act on the event */
        var property = $(".column option:selected").attr('dtype');
        property = Number(property);
        if(property==0||property+1==0){
            $('#valueinput').show('fast');
            $('#caldateinput').hide('fast');
            if(property==0){
                $(".operator").show('fast');
                $(".likeOperator").hide('fast');
            } else {
                $(".operator").hide('fast');
                $(".likeOperator").show('fast');
            }
        } else {
            $('#caldateinput').show('fast');
            $('#valueinput').hide('fast');
            $(".operator").show('fast');
            $(".likeOperator").hide('fast');
        }
    });

    //3、点击保存按钮
    //以上1、2、3为filter的共三个功能
    $("#filterModal").on("click",".modalfiltersave",function () {
        var filterColumn = [];
        $('#filterModal').modal('hide')
        for(f in _global_filter_temp){
            filterColumn.push(_global_filter_temp[f]);
        }
        controller_data.filterColumn = filterColumn;
        controller_data.filter = _global_filter_temp;
        drawTable();
    })
});

</script>
</@script>