	<#include "/emp2/common/_layout.html"/>
<@css>

  <link href="${base_path}/emp2/js/advanced-datatable/css/demo_page.css" rel="stylesheet">
  <link href="${base_path}/emp2/js/advanced-datatable/css/demo_table.css" rel="stylesheet">
 <link href="${base_path}/emp2/js/data-tables/DT_bootstrap.css" rel="stylesheet"> 
  
</@css>
<@layout>
       <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="pieModel" class="modal fade">
           <div class="modal-dialog modal-lg">
               <div class="modal-content" style="width:1000px;">
                   <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                       <h4 class="modal-title">区县能源消费情况</h4>
                   </div>
                  <div class="modal-body">
					<div class="chart">
					<div class="row">
					  <div class="col-md-6"><div id="chartpieA"></div></div>
					  <div class="col-md-6"><div id="chartpieB"></div></div>
					</div>
					<div class="row">
					  <div class="col-md-6"><div id="chartpieC"></div></div>
					  <div class="col-md-6"><div id="chartpieD"></div></div>
					</div>
				   </div>
     			   </div>
               </div>
           </div>
       </div>
       <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="lineModel" class="modal fade">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                       <h4 class="modal-title">区县同比信息</h4>
                   </div>
                  <div class="modal-body">
					<div class="chart"><div id="chartB"></div></div>
     			   </div>
               </div>
           </div>
       </div>
        <!-- page heading start-->
        <div class="page-heading">
            <h3>
                &nbsp;&nbsp;商品列表
            </h3>
            <!-- qgy 
            <ul class="breadcrumb">
                <li>
                    <a href="#">Dashboard</a>
                </li>
                <li>
                    <a href="#">Data Tables</a>
                </li>
                <li class="active"> Dynamic Table </li>
            </ul>
            -->
        </div>
        <!-- page heading end-->

        <!--body wrapper start-->
        <div class="wrapper">
        <div class="row">
        <div class="col-sm-12">
        <section class="panel">
        <!--  
        <header class="panel-heading">
            DataTables hidden row details example
            <span class="tools pull-right">
                <a href="javascript:;" class="fa fa-chevron-down"></a>
                <a href="javascript:;" class="fa fa-times"></a>
             </span>
        </header>
         -->
        <div class="panel-body">
        <div class="adv-table">
        <table class="display table table-bordered" id="hidden-table-info">
        <thead>
        <tr id="tableTheadTemplateTarget">
            <th>Rendering engine</th>
            <th>Browser</th>
            <th class="hidden-phone">Platform(s)</th>
            <th class="hidden-phone">Engine version</th>
            <th class="hidden-phone">CSS grade</th>
            <th class="hidden-phone">CSS grade</th>
        </tr>
        </thead>
        <tbody id="tableTdTemplateTarget">
        <tr class="gradeX">
            <td>Trident</td>
            <td>Internet
                Explorer 4.0</td>
            <td class="hidden-phone">Win 95+</td>
            <td class="center hidden-phone">4</td>
            <td class="center hidden-phone">X</td>
            <td class="center hidden-phone">X</td>
        </tr>
        </tbody>
        </table>

        </div>
        </div>
        </section>
        </div>
        </div>
        </div>
        <!--body wrapper end-->

<!--         footer section start
        <footer>
            2014 &copy; AdminEx by ThemeBucket
        </footer>
        footer section end -->

</section>
</@layout> 
<@script>
    <#include "/emp2/saleForce/tableComp.html"/>
    <script src="${base_path}/emp2/js/jsrender.js" type="text/javascript"></script>
    <script src="${base_path}/js/layer/layer.js" type="text/javascript"></script>
    <script type="text/javascript">
        var schema_data = {};
        var form_data = [];
        var meta_data = [];
        var model_data = [];
		_window_height = $(window).height();
		_window_width = $(window).width();
		var categoryArrayMap = {};
        var initSchema = function () {
            var url = '${base_path}/eco/getSchema';
            var fun = function (data) {
                meta_data = [{'displayname':"区域编码"},{'displayname':"区域名称"},{'displayname':"能源总消耗"},
                             {'displayname':"原煤"},{'displayname':"天然气(气态)"},{'displayname':"汽油"},
                             {'displayname':"电力"},{'displayname':"占比信息"},{'displayname':"同比信息"}]; 
                schema_data =data.schema_list[0]; 
                queryForForm(schema_data);
            };
            var errfun = function () {};
            var datatype = 'json';
            var data = {'userId':${userid},'token':1};
            commonPost(url,fun,errfun,datatype,data);
        }

        var queryForForm = function (schema_data) {
            var url = '${base_path}/eco/getFormData';
            var fun = function (data) {
                form_data = data;
                renderTable(form_data,meta_data);
                initDynamicTable();
                // layer.closeAll('loading');
            }
            var errfun = function (data) {

            }
            var datatype = 'json';
            var data = {'userId':${userid},'token':1};
        	var extcolumn = {"numbercolumn":"energyvalue",
				     "columnname":"energycode",
				     "columoptions":["01","15","33","19"], 
				     "columnfunction":"proportion"
					};
	       var tempdata = {"groupdata":[{"columname":"districtid","displayname":"区域编码","selectable":1},
	                                    {"columname":"districtname","displayname":"区县名称","selectable":1},
								        {"columname":"energycode","displayname":"能源种类","selectable":1}],
		                   "numberdata":[{"columname":"energyvalue","displayname":"能源值","property":"0"}]};
            $.each(schema_data.data.groupdata, function(index, val) {
                delete val.optionalItems
            });
            data.data = JSON.stringify(tempdata);
            data.schemaid = schema_data.schemaid;
            data.extcolumn = JSON.stringify(extcolumn);
            commonPost(url,fun,errfun,datatype,data);            
        }

        var renderTable = function (form_data,meta_data) {
            $( "#tableTdTemplateTarget" ).html(
                $( "#tableTdTemplate" ).render( form_data )
            );

            $( "#tableTheadTemplateTarget" ).html(
                $( "#tableTheadTemplate" ).render( meta_data )
            );

        }
       
        function commonPost(url,fun,errfun,datatype,data,async){
          if (!datatype) {
            datatype="text"
          };
          if (!async) {
            async = false;
          };
          $.ajax({
              url:url,
              dataType:datatype,
              async:async,
              type: "POST",
              success:fun,
              data:data
          }).fail(
              errfun
          )
        }
		$(document).on('click','.showpie', function(event) {
			event.preventDefault();
			var nRow = $(this).parents('tr')[0];
			var jqTds = $('>td', nRow);
			var districtid = jqTds[1].innerText;
			var data = {};
			var dataA = {};
			var dataB = {};
			var dataC = {};
			var count = 0;
			
			data.userId = ${userid};
			data.token = 1;
			data.schemaid = 15;
			var tempdata = {};
			var datacontent= {};
			tempdata.datatype=3;
			tempdata.graphtype = "pie";
			tempdata.schemaid = 15;
			datacontent.groupcolumn=["energycodename"];
			datacontent.numbercolumn= [{
		            "element": "energyvalue",
		            "functionName": "max"
		        }]
			datacontent.filetercolumn=[{"itemName":"districtid","operator":"=","value":districtid,"displayName":"区域编码"}]  
			datacontent.fileterGroupColumn=[];
			datacontent.collapse={"columnname":"energycodename","keepoption":["原煤"],"columndisplay":"总消耗","collapsedisplay":"其他能源"} 
			tempdata.datacontent=datacontent;
			
			
			dataA.userId = ${userid};
			dataA.token = 1;
			dataA.schemaid = 15;
			var tempdataA = {};
			tempdataA.datatype=3;
			tempdataA.graphtype = "pie";
			tempdataA.schemaid = 15;
			var datacontentA= {};
			datacontentA.groupcolumn=["energycodename"];
			datacontentA.numbercolumn= [{
		            "element": "energyvalue",
		            "functionName": "max"
		        }]
			datacontentA.filetercolumn=[{"itemName":"districtid","operator":"=","value":districtid,"displayName":"区域编码"}]  
			datacontentA.fileterGroupColumn=[];
			datacontentA.collapse={"columnname":"energycodename","keepoption":["天然气(气态)"],"columndisplay":"总消耗","collapsedisplay":"其他能源"} 
			tempdataA.datacontent=datacontentA;
			
			dataB.userId = ${userid};
			dataB.token = 1;
			dataB.schemaid = 15;
			var tempdataB = {};
			tempdataB.datatype=3;
			tempdataB.graphtype = "pie";
			tempdataB.schemaid = 15;
			var datacontentB= {};
			datacontentB.groupcolumn=["energycodename"];
			datacontentB.numbercolumn= [{
		            "element": "energyvalue",
		            "functionName": "max"
		        }]
			datacontentB.filetercolumn=[{"itemName":"districtid","operator":"=","value":districtid,"displayName":"区域编码"}]  
			datacontentB.fileterGroupColumn=[];
			datacontentB.collapse={"columnname":"energycodename","keepoption":["汽油"],"columndisplay":"总消耗","collapsedisplay":"其他能源"} 
			tempdataB.datacontent=datacontentB;
			
			dataC.userId = ${userid};
			dataC.token = 1;
			dataC.schemaid = 15;
			var tempdataC = {};
			tempdataC.datatype=3;
			tempdataC.graphtype = "pie";
			tempdataC.schemaid = 15;
			var datacontentC={};
			datacontentC.groupcolumn=["energycodename"];
			datacontentC.numbercolumn= [{
		            "element": "energyvalue",
		            "functionName": "max"
		        }]
			datacontentC.filetercolumn=[{"itemName":"districtid","operator":"=","value":districtid,"displayName":"区域编码"}]  
			datacontentC.fileterGroupColumn=[];
			datacontentC.collapse={"columnname":"energycodename","keepoption":["电力"],"columndisplay":"总消耗","collapsedisplay":"其他能源"} 
			tempdataC.datacontent=datacontentC;
			
			
			data.data = JSON.stringify(tempdata);
			dataA.data = JSON.stringify(tempdataA);
			dataB.data = JSON.stringify(tempdataB);
			dataC.data = JSON.stringify(tempdataC);
			
			var url = '${base_path}/eco/getChartData';
			var fun = function (result) {
				var temp= result;
				model_data[count] = temp;
				count ++;
				if(count==4){
					$('#pieModel').modal('show');
				}
			};
			var errfun = function () {};
			var datatype = 'json';
			var datatemplateA = data;
			var datatemplateB = dataA;
			var datatemplateC = dataB;
			var datatemplateD = dataC;
			commonPost(url,fun,errfun,datatype,datatemplateA,false); 
			commonPost(url,fun,errfun,datatype,datatemplateB,false); 
			commonPost(url,fun,errfun,datatype,datatemplateC,false); 
			commonPost(url,fun,errfun,datatype,datatemplateD,false); 
		
		});
		
		$(document).on('click','.showline', function(event) {
			event.preventDefault();
			var now = new Date();
			var nRow = $(this).parents('tr')[0];
			var jqTds = $('>td', nRow);
			var districtid = jqTds[1].innerText;
			var data = {};
			var nowmonth =getNowFormatMonth() ;
			var tommonth =getTomorrowMonth();
			data.userId = ${userid};
			data.token = 1;
			data.schemaid = 15;
			var tempdata = {};
			var datacontent= {};
			tempdata.datatype=2;
			tempdata.graphtype = "line";
			tempdata.schemaid = 15;
			datacontent.groupcolumn=["energycodename",
	            					 "time_month"];
			datacontent.numbercolumn= [{
		            "element": "energyvalue",
		            "functionName": "max"
		        }]
			datacontent.filetercolumn=[{"itemName":"districtid","operator":"=","value":districtid,"displayName":"区域编码"}]  
			datacontent.fileterGroupColumn=[{"element":"time_month","value":[nowmonth,tommonth]}]
			datacontent.collapse={"columnname":"energycodename","keepoption":["原煤","天然气(气态)","汽油","电力"],"columndisplay":"总消耗","collapsedisplay":"其他能源"} 
			tempdata.datacontent=datacontent;
			data.data = JSON.stringify(tempdata);
			var url = '${base_path}/eco/getChartData';
			var fun = function (result) {
				model_data = result;
				$('#lineModel').modal('show');
			};
			var errfun = function () {};
			var datatype = 'json';
			var datatemplate = data;
			commonPost(url,fun,errfun,datatype,datatemplate,false); 
		
		});
		
	    $("#pieModel").one('shown.bs.modal', function (e) {
	    	var data = model_data;
	    	var textdata=meta_data;
	    	drawChartA("#chartA",categoryArrayMap,"","");
	    	drawPieChart("#chartpieA",data[0].data.datacontent,data[0].data.datatype,textdata[3]);
	    	drawPieChart("#chartpieB",data[1].data.datacontent,data[1].data.datatype,textdata[4]);
	    	drawPieChart("#chartpieC",data[2].data.datacontent,data[2].data.datatype,textdata[5]);
	    	drawPieChart("#chartpieD",data[3].data.datacontent,data[3].data.datatype,textdata[6]);
        })
        $("#lineModel").one('shown.bs.modal', function (e) {
	    	var data = model_data;
	    	var type="column" ;
            seriesArrayMap = data.data.datacontent;
            categoryArrayMap = data.data.datacontent.xAxis.categories;
			seriesArrayMap = data.data.datacontent.series;
	    	drawChartA("#chartB",categoryArrayMap,seriesArrayMap,type);
        })
        $("#pieModel").one('hidden.bs.modal', function (e) {
        	 location.reload();
        })
        $("#lineModel").one('hidden.bs.modal', function (e) {
        	 location.reload();
        })
		var drawPieChart = function (domSelector,dataSeries,datatype,text,height) {
			// body...
			if(!height){
				height = (_window_height-350)/2;
			}
			var chartSeries = dataSeries.series?dataSeries.series:dataSeries
			var drilldown = dataSeries.drilldown;
			var options = {
		        chart: {
		        	type:'pie',
		            plotBackgroundColor: null,
		            plotBorderWidth: null,
		            plotShadow: false,
		    		height:height
		        },
		    	exporting:{
		    		enabled:false	
		    	},
		        title: {
		            text: text.displayname+"占比情况"
		        },
		        tooltip: {
		    	    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		        },
		        plotOptions: {
		            pie: {
		                allowPointSelect: true,
		                cursor: 'pointer',
		                dataLabels: {
		                    enabled: true,
		                    color: '#000000',
		                    connectorColor: '#000000',
		                    format: '<b>{point.name}</b>:{point.percentage:.1f}%',
		                    style: {
								fontSize: '10pt',
								padding: '4px'
							},
		                }
		            }
		        },
		        credits: {  
		        	  enabled: false  
		        },
		        series: chartSeries
		    };
		    if(datatype ==4){
		    	if(drilldown){
		    		options.drilldown = drilldown;
		    	} else {
		    		options.drilldown = {};
		    	}
		    	
		    }
		    $(domSelector).highcharts(options);
		}
	    
	    var drawChartA=function(domSelector,categoryArray,seriesArray,type,height,width){
			var tempCategory = categoryArray;
			var tempSeries = seriesArray;
			if(tempCategory){
				tempCategory = JSON.parse(JSON.stringify(tempCategory));
			}
			if(tempSeries){
				tempSeries = JSON.parse(JSON.stringify(tempSeries));
			}
			if(!type){
				type='line';
			}
			if(!height){
				height = (_window_height-350)/2;
			}
			var HCoption = 
			{
		    	chart:{
		    		type:type,
		    		height:height
		    	},
		    	exporting:{
		    		enabled:false	
		    	},
		        title: {
		            text: null,
		            x: -20 //center
		        },
		        subtitle: {
		            text: null,
		            x: -20
		        },
		        xAxis: {
		            categories: tempCategory
		        },
		        yAxis: {
		            title: {
		                text:null
		            },
		            min:0,
		            plotLines: [{
		                value: 0,
		                width: 1,
		                color: '#808080'
		            }]
		        },
		        tooltip: {
		            valueSuffix: null
		        },
		        legend: {
		        	enabled:false,
		            layout: 'vertical',
		            align: 'right',
		            verticalAlign: 'middle',
		            borderWidth: 0
		        },
		        credits: {  
		        	  enabled: false  
		        },
		        series: tempSeries				
			}
            if(type=='column_complex'){
                type='column';
                var plotOptions = {column:{stacking:'normal'}};
                HCoption.plotOptions = plotOptions;
                HCoption.chart.type = type;
            }
			if(width){
				HCoption.chart.width=width;
			}
		    $(domSelector).highcharts(HCoption);
		}
        $(document).ready(function() {
            // layer.load(2);
            $(document).ajaxError(function(event, xhr, settings, thrownError) {
                /* Stuff to do when an AJAX call returns an error */;
                if(xhr.status === 401){
                    location.href="${base_path}/"
                }
            });
            initSchema();
       //     initChart(['#chart'],undefined,uuidArray,true) ;   
        } );
        function getNowFormatMonth(){
            var day = new Date();
            var Year = 0;
            var Month = 0;
            var Day = 0;
            var CurrentDate = "";
            Year= day.getFullYear();//支持IE和火狐浏览器.
            Month= day.getMonth()+1;
            Day = day.getDate();
            CurrentDate += Year;
            if (Month >= 10 ){
             CurrentDate += Month;
            }
            else{
             CurrentDate += "0" + Month;
            }
            return CurrentDate;
         }
        function getTomorrowMonth(){
            var day = new Date();
            var Year = 0;
            var Month = 0;
            var Day = 0;
            var CurrentDate = "";
            Year= day.getFullYear();//支持IE和火狐浏览器.
            Month= day.getMonth();
            Day = day.getDate();
            CurrentDate += Year;
            if (Month >= 10 ){
             CurrentDate += Month;
            }
            else{
             CurrentDate += "0" + Month;
            }
            return CurrentDate;
         }
    </script>
	<script type="text/javascript"
		src="${base_path}/emp2/js/advanced-datatable/js/jquery.dataTables.js"></script>
	<script type="text/javascript"
		src="${base_path}/emp2/js/data-tables/DT_bootstrap.js"></script>
	<script type="text/javascript"
		src="${base_path}/emp2/js/dynamic_table_init.js"></script>
</@script>