<#include "/html/common/_layout.html"/>
<@layout>
<!-- Matter -->

<div class="matter">
    <div class="container">
        <div class="row">
            <!--<div class="col-md-1"></div>-->
            <div class="col-md-12">
                <div class="widget">

                    <div class="widget-head">
                        <div class="pull-left">创建习题</div>
                        <div class="widget-icons pull-right">
                            <a href="#" class="wminimize"><i class="fa fa-chevron-up"></i></a>
                        </div>
                        <div class="clearfix"></div>
                    </div>

                    <div class="widget-content">
                        <div class="padd">
                            <div id="preview" style="min-height: 50px;"></div>
                            <div style="margin-top: 10px">题目名称</div>
                            <div><input type="text" id="testname" style="border: 1px #668800 solid"></div>
                            <div style="margin-top: 5px">选择组别</div>
                            <div>
                                <select id="group">
                                    <option value="0">新分组</option>
                                    <#list recordlist as record>
                                        <option value="${record.id}">${record.group_name}</option>
                                    </#list>
                                </select>
                                <input type="text" id="newgroup" style="border: 1px #668800 solid;margin-left: 10px">
                            </div>
                            <div>题目编辑，有图片请直接拖入下框</div>
                            <div style="min-height: 300px;border: 1px #668800 solid">
                                <textarea id="dropzone" style="width: 100%;height: 300px;border: none;"></textarea>
                            </div>
                            <div>答案：请填写选项，单选如c，多选如abc</div>
                            <div><input type="text" id="answer" style="border: 1px #668800 solid"><input id="submitbtn" type="button" value="提交题目" style="margin-left: 10px"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--<div class="col-md-1"></div>-->
        </div>
    </div>
</div>
</@layout>
<@script>
<script type="text/javascript">
    var isAdvancedUpload = function() {
        var div = document.createElement('div');
        return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
    }();

    var successfun = function(){
        console.log("sucess")
    }
    var errfun = function(){
        console.log("err")
    }

    function submitform(){
        var ajaxData =
        {
            "createtest.name":$("#testname").val(),
            "createtest.html":$("#preview").html(),
            "createtest.answer":$("#answer").val(),
            "createtest.group":$("#group").val(),
            "createtest.newgroup":$("#newgroup").val()
        };
        commonPost('${base_path}/livevip/createTest',setMessageReload,defaultFailCallback,"json",ajaxData)
    }
$(function(){
    if (isAdvancedUpload) {

        var droppedFiles = false;

        var $dropzone = $("#dropzone");

        $(document).on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        })

        $dropzone.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        })
        .on('dragover dragenter', function() {
            console.log("dragover")
        })
        .on('dragleave dragend drop', function() {
            console.log("dragleave")
        })
        .on('drop', function(e) {
            droppedFiles = e.originalEvent.dataTransfer.files;

            var ajaxData = new FormData();

            if (droppedFiles) {
                $.each( droppedFiles, function(i, file) {
                    ajaxData.append( 'upload', file );
                });
            }

            $.ajax({
                url: '${base_path}/livevip/uploadimg',
                type: 'post',
                data: ajaxData,
                dataType: 'json',
                cache: false,
                contentType: false,
                processData: false,
                complete: function(data) {
                    console.log(data)
                    console.log('upload complete');
                },
                success: function(data) {
//                    $('#dropzone').insertAtCaret(data.uploadpath);
                    var imghtml = '<img src="'+data.webserverpath+'">';
                    $('#dropzone').insertAtCaret(imghtml);
                    //$("#preview").html(imghtml)
                },
                error: function() {
                    // Log the error, show an alert, whatever works for you
                }
            });
        });

    }

    function refresh_preview(){
        $("#preview").html($('#dropzone').val().replace(/\n/g,"<br>"))
    }

    setInterval(refresh_preview,1000)

    $("#dropzone").on("change",$.debounce( 1000, refresh_preview ))

    $("#submitbtn").on("click",submitform)

    var createcallback = function(){
        setMessage("操作成功")
        location.href="${base_path}/livevip/toCreateLiveVip"
    }

    var createvipclick = function(){
//        var validated = $('form').validationEngine("validate");
//        if(!validated){
//            return;
//        }
//        commonPost("${base_path}/livevip/createLiveVip",createcallback,errfun,null,$('#form1').serialize(),true)
    }
    $(".btn").on("click",function(){
        createvipclick();
    })
//    $("#dropzone").on("keypress",function(event){
//        if(event.which==13){
//            $('#dropzone').insertAtCaret("<br>");
//        }
//    })
//    $(window).keypress(function(event){
//        if(event.which==13){
//            createvipclick();
//        }
//    })
    $('form').validationEngine();

})
</script>
</@script>